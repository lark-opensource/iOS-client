//
//  OpenPluginReportCardMonitorAPI.swift
//  LarkOpenApis
//
//  GENERATED BY ANYCODE on 2023/7/13 03:55:13
//

import Foundation
import LarkOpenAPIModel
import ECOProbe
import LarkOpenPluginManager
import LarkContainer

// MARK: - OpenPluginReportCardMonitorAPI
final class UniversalCardReportMonitorAPI: UniversalCardAPIPlugin {
    private static let domain = "client.open_platform.card"
    
    func reportCardMonitor(
        params: UniversalCardReportMonitorRequest,
        context: UniversalCardAPIContext,
        callback: @escaping (OpenAPIBaseResponse<OpenAPIBaseResult>) -> Void) {
            let monitorEvent = params.monitorEvents
            for event in monitorEvent {
                guard let event = event as? [String: Any] else {
                    callback(.failure(error: OpenAPIError(errno: OpenAPICommonErrno.internalError,msg: "eventDate is not dictionary") ))
                    return
                }
                guard let eventName = event["event_name"] as? String,
                      let categories = event["categories"] as? [String: Any],
                      let code = categories["monitor_code"] as? Int,
                      let message = categories["monitor_message"] as? String else {
                    callback(.failure(error: OpenAPIError(errno: OpenAPICommonErrno.internalError,msg: "event_name or categories is nil")))
                    return
                }
                let cardCode = OPMonitorCodeBase(domain: Self.domain, code: code, level: OPMonitorLevelNormal, message: message)
                let monitor = OPMonitor(name: eventName, code: cardCode)
                monitor.addMap(categories)
                monitor.flush()
            }
            callback(.success(data: nil))
    }

    required public init(resolver: UserResolver) {
        super.init(resolver: resolver)
        registerCardAsyncHandler(for: "UniversalCardReportMonitor", pluginType: Self.self, paramsType: UniversalCardReportMonitorRequest.self, resultType: OpenAPIBaseResult.self) { (this, params, context, callback) in
            context.apiTrace.info("reportCardMonitor API call start")
            this.reportCardMonitor(params: params, context: context, callback: callback)
            context.apiTrace.info("reportCardMonitor API call end")
        }
    }
}
